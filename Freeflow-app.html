<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FreeFlow — Voice to order</title>
  <!-- Ikony -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🌀</text></svg>">
  <!-- Prosty, lekki styl (bez Tailwinda/ram) -->
  <style>
    :root{
      --bg:#0c0f14; --panel:#141823; --muted:#8ca3b3; --text:#e9f1f6; --brand:#ff7a1a; --ok:#1ed760; --err:#ff4d4f;
      --card:#111625; --btn:#1f2737; --btnh:#26324a; --border:#233147;
    }
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(120deg,#0c0f14,#0e121a 40%,#0a0e15);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto}
    a{color:inherit}
    .top {position:sticky;top:0;z-index:5;background:#0d1219cc;backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid var(--border)}
    .shell{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;align-items:center;gap:12px}
    .grow{flex:1}
    .brand{font-size:26px;font-weight:800;letter-spacing:.2px}
    .brand span{color:var(--brand)}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--btn);border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{background:var(--btnh)}
    .iconbtn{width:42px;height:42px;display:grid;place-items:center;border-radius:12px}
    .pill{min-width:20px;height:20px;border-radius:999px;background:var(--brand);color:#000;font-weight:700;display:grid;place-items:center;padding:0 6px;font-size:12px}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px 48px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgb(0 0 0 / 25%)}
    .stack{display:grid;gap:12px}
    input,select,textarea{width:100%;background:#0f1420;border:1px solid var(--border);border-radius:12px;color:var(--text);padding:12px 14px}
    textarea{min-height:92px;resize:vertical}
    .muted{color:var(--muted);font-size:14px}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#0f1726;border:1px dashed var(--border);padding:6px 10px;border-radius:10px}
    .ok{color:var(--ok)} .err{color:var(--err)}
    /* Drawer */
    .drawer{position:fixed;inset:0;display:none}
    .drawer.open{display:block}
    .shade{position:absolute;inset:0;background:#0008}
    .panel{position:absolute;right:0;top:0;bottom:0;width:92vw;max-width:460px;background:var(--card);border-left:1px solid var(--border);padding:18px 14px 20px;overflow:auto}
    .section{border:1px solid var(--border);border-radius:14px;background:var(--panel);padding:10px 10px;margin:12px 0}
    .section h3{margin:6px 6px 10px;font-size:15px;font-weight:700;letter-spacing:.2px}
    .item{background:#0f1420;border:1px solid var(--border);border-radius:12px;padding:12px;margin:8px}
    .right{margin-left:auto}
    .row.wrap{flex-wrap:wrap}
    .hide{display:none}
    .divider{height:1px;background:var(--border);margin:8px 0}
    .link{color:#bcd4e2;text-decoration:underline;cursor:pointer}
    .badge-mini{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border)}
    .danger{background:#261116;border-color:#3a1a1a}
    @media (max-width:520px){ .brand{font-size:22px} }
  </style>
  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
</head>
<body>
  <!-- TOP BAR -->
  <header class="top">
    <div class="shell row">
      <button id="btnMenu" class="btn iconbtn" aria-label="menu">☰</button>
      <div class="brand"><span>Free</span>Flow</div>
      <div class="grow"></div>
      <div class="row">
        <span id="badgeUser" class="badge muted">Niezalogowany</span>
        <button id="btnCart" class="btn iconbtn" aria-label="koszyk">🛒</button>
        <span id="cartCount" class="pill" title="Koszyk">0</span>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="wrap">
    <div class="card stack">
      <div class="row" style="gap:10px;align-items:flex-end">
        <div class="grow">
          <label class="muted">URL backendu (Vercel)</label>
          <input id="backendUrl" placeholder="https://freeflow-backend-vercel.vercel.app" />
        </div>
        <button id="btnSaveCfg" class="btn">Zapisz</button>
        <button id="btnPing" class="btn">Ping /health</button>
      </div>
      <div id="pingState" class="muted">Stan: nieznany</div>
    </div>

    <div class="card stack" style="margin-top:16px">
      <div class="row wrap" style="gap:10px">
        <div class="grow">
          <label class="muted">Wyszukiwanie po lokalizacji</label>
          <input id="searchInput" placeholder="Wpisz miasto lub adres..." />
        </div>
        <button class="btn iconbtn" id="btnSearch" title="Szukaj">🔎</button>
      </div>
      <div class="divider"></div>
      <div class="row"><h2 style="margin:0;font-size:18px">Asystent</h2><span class="muted right">krótkie odpowiedzi PL</span></div>
      <textarea id="prompt" placeholder="Np. Zamówić dwie pizze na Kazimierzu — jaka dzielnica?"></textarea>
      <div class="row">
        <button id="btnAsk" class="btn">Wyślij do /api/gpt</button>
        <span id="askState" class="muted"></span>
        <span class="right badge ok hide" id="badgeOk">OK</span>
        <span class="right badge err hide" id="badgeErr">Błąd</span>
      </div>
      <div id="reply" class="item muted"></div>
    </div>
  </main>

  <!-- DRAWER -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="shade" id="shade"></div>
    <div class="panel">
      <div class="row">
        <div class="brand"><span>Free</span>Flow</div>
        <div class="grow"></div>
        <button id="btnClose" class="btn iconbtn" aria-label="zamknij">✕</button>
      </div>

      <div id="debugInfo" class="muted" style="margin:10px 8px">Menu otwarty. expanded: brak, showAuth: false</div>

      <!-- LOKALIZACJA -->
      <div class="section">
        <h3>Wyszukiwanie po lokalizacji</h3>
        <div class="item row">
          <input id="locInput" placeholder="Miasto / adres" />
          <button class="btn" id="locBtn">Szukaj</button>
        </div>
      </div>

      <!-- KLIENT PRYWATNY -->
      <div class="section">
        <h3>Klient Prywatny</h3>

        <div class="item" id="boxSignedOut">
          <div class="muted" style="margin-bottom:8px">Zaloguj się</div>
          <div class="stack">
            <input id="authEmail" type="email" placeholder="e-mail" />
            <input id="authPass" type="password" placeholder="hasło" />
            <div class="row">
              <button class="btn" id="btnLogin">Zaloguj się</button>
              <button class="btn" id="btnSignup">Zarejestruj</button>
            </div>
          </div>
        </div>

        <div class="item hide" id="boxSignedIn">
          <div class="row">
            <div>
              <div class="muted">Zalogowany jako</div>
              <div id="userEmail" style="font-weight:700"></div>
            </div>
            <div class="grow"></div>
            <button class="btn danger" id="btnLogout">Wyloguj</button>
          </div>
          <div class="divider"></div>
          <div class="stack">
            <button class="btn">Moje zamówienia / historia</button>
            <button class="btn">Ulubione restauracje</button>
          </div>
        </div>
      </div>

      <!-- FIRMA -->
      <div class="section">
        <h3>Firma</h3>
        <div class="item stack">
          <button class="btn">Zamówienia firmowe</button>
          <button class="btn">Faktury / NIP</button>
        </div>
      </div>

      <!-- WSPARCIE -->
      <div class="section">
        <h3>Wsparcie i Ustawienia</h3>
        <div class="item stack">
          <button class="btn">FAQ / pomoc</button>
          <button class="btn">Ustawienia aplikacji</button>
          <div class="row">
            <select id="lang">
              <option value="pl">Polski</option>
              <option value="en">English</option>
            </select>
            <select id="currency">
              <option value="PLN">PLN</option>
              <option value="EUR">EUR</option>
            </select>
          </div>
        </div>

        <div class="item">
          <div class="muted">Konfiguracja Supabase (publiczne)</div>
          <div class="stack">
            <input id="sbUrl" placeholder="https://xxxx.supabase.co" />
            <input id="sbAnon" placeholder="SUPABASE_ANON_KEY" />
            <button class="btn" id="btnSaveSb">Zapisz i połącz</button>
          </div>
        </div>
      </div>

      <div class="muted" style="margin:10px 8px">
        <span class="badge-mini">FreeFlow</span>
      </div>
    </div>
  </aside>

  <script>
    // --- stan & utils ---
    const $ = (q)=>document.querySelector(q);
    const drawer = $('#drawer'); const shade = $('#shade');
    const btnMenu = $('#btnMenu'); const btnClose = $('#btnClose');
    const backendUrl = $('#backendUrl'); const btnSaveCfg = $('#btnSaveCfg');
    const btnPing = $('#btnPing'); const pingState = $('#pingState');
    const promptEl = $('#prompt'); const btnAsk = $('#btnAsk'); const reply = $('#reply');
    const askState = $('#askState'); const badgeOk = $('#badgeOk'); const badgeErr = $('#badgeErr');
    const cartCount = $('#cartCount'); const badgeUser = $('#badgeUser'); const debugInfo = $('#debugInfo');
    const boxSignedOut = $('#boxSignedOut'); const boxSignedIn = $('#boxSignedIn'); const userEmail = $('#userEmail');
    const authEmail = $('#authEmail'); const authPass = $('#authPass');
    const btnLogin = $('#btnLogin'); const btnSignup = $('#btnSignup'); const btnLogout = $('#btnLogout');
    const sbUrl = $('#sbUrl'); const sbAnon = $('#sbAnon'); const btnSaveSb = $('#btnSaveSb');

    let supa = null;

    function saveCfg(){
      localStorage.setItem('freeflow_backend', backendUrl.value.trim());
      pingState.textContent = 'Zapisano.';
    }
    function loadCfg(){
      backendUrl.value = localStorage.getItem('freeflow_backend') || '';
      sbUrl.value = localStorage.getItem('freeflow_sb_url') || '';
      sbAnon.value = localStorage.getItem('freeflow_sb_anon') || '';
      if (sbUrl.value && sbAnon.value) connectSupabase();
    }
    function showDrawer(open){
      drawer.classList.toggle('open', !!open);
      drawer.setAttribute('aria-hidden', open?'false':'true');
      debugInfo.textContent = `Menu ${open?'otwarty':'zamknięty'}. expanded: brak, showAuth: ${boxSignedOut.classList.contains('hide')}`;
    }
    function setUser(u){
      if (u){
        boxSignedOut.classList.add('hide'); boxSignedIn.classList.remove('hide');
        userEmail.textContent = u.email || '(bez e-mail)'; badgeUser.textContent = 'Zalogowany';
      }else{
        boxSignedIn.classList.add('hide'); boxSignedOut.classList.remove('hide');
        badgeUser.textContent = 'Niezalogowany';
      }
    }
    function spin(node, on=true){ node.classList.toggle('muted', on); }

    // --- backend calls ---
    async function ping(){
      const base = backendUrl.value.trim();
      if(!base){ pingState.textContent='Wpisz URL backendu'; return; }
      spin(btnPing,true);
      try{
        const r = await fetch(base.replace(/\/$/,'')+'/api/health');
        const ok = r.ok; const txt = await r.text();
        pingState.innerHTML = `Stan: ${ok?'<span class="ok">OK</span>':'<span class="err">BŁĄD</span>'} — <span class="muted">${txt}</span>`;
      }catch(e){
        pingState.innerHTML = `Stan: <span class="err">BŁĄD</span> — ${e.message}`;
      }finally{ spin(btnPing,false); }
    }
    async function ask(){
      const base = backendUrl.value.trim();
      const prompt = promptEl.value.trim();
      if(!base){ askState.textContent='Podaj URL backendu'; return; }
      if(!prompt){ askState.textContent='Wpisz prompt'; return; }
      askState.textContent='Wysyłam...'; badgeOk.classList.add('hide'); badgeErr.classList.add('hide');
      try{
        const r = await fetch(base.replace(/\/$/,'')+'/api/gpt', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ prompt })
        });
        const data = await r.json().catch(()=>({}));
        if(!r.ok){ throw new Error(data?.error||('HTTP '+r.status)); }
        reply.textContent = data.reply || JSON.stringify(data);
        askState.textContent=''; badgeOk.classList.remove('hide');
        cartCount.textContent = String(Number(cartCount.textContent||'0')+1); // demo „akcji”
      }catch(e){
        askState.textContent = e.message;
        badgeErr.classList.remove('hide');
      }
    }

    // --- supabase ---
    function connectSupabase(){
      try{
        supa = window.supabase.createClient(sbUrl.value.trim(), sbAnon.value.trim(), { auth:{ persistSession:true } });
        localStorage.setItem('freeflow_sb_url', sbUrl.value.trim());
        localStorage.setItem('freeflow_sb_anon', sbAnon.value.trim());
        pingState.innerHTML = 'Połączono z Supabase.';
        supa.auth.getUser().then(({data})=> setUser(data?.user||null));
        supa.auth.onAuthStateChange((_e,session)=> setUser(session?.user||null));
      }catch(e){
        pingState.innerHTML = `<span class="err">Błąd Supabase:</span> ${e.message}`;
      }
    }
    async function doLogin(signup=false){
      if(!supa){ pingState.innerHTML='Najpierw zapisz dane Supabase i połącz.'; return; }
      const email = authEmail.value.trim(); const password = authPass.value.trim();
      if(!email||!password){ return alert('Podaj e-mail i hasło'); }
      try{
        if(signup){
          const {error} = await supa.auth.signUp({ email, password });
          if(error) throw error; alert('Sprawdź e-mail (potwierdzenie)');
        }else{
          const {error} = await supa.auth.signInWithPassword({ email, password });
          if(error) throw error;
        }
      }catch(e){ alert('Auth error: '+e.message); }
    }
    async function doLogout(){ if(supa) await supa.auth.signOut(); }

    // --- events ---
    btnMenu.onclick = ()=>showDrawer(true);
    btnClose.onclick = shade.onclick = ()=>showDrawer(false);
    btnSaveCfg.onclick = saveCfg; btnPing.onclick = ping; btnAsk.onclick = ask;
    btnSearch.onclick = ()=>alert('To tylko demo wyszukiwarki 🙂');
    $('#locBtn').onclick = ()=>alert('Szukam w: '+($('#locInput').value||'(puste)'));
    btnLogin.onclick = ()=>doLogin(false);
    btnSignup.onclick = ()=>doLogin(true);
    btnLogout.onclick = doLogout;
    btnSaveSb.onclick = connectSupabase;

    // init
    loadCfg();
    // auto ping gdy mamy URL
    if(backendUrl.value) ping();
  </script>
</body>
</html>
