<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FreeFlow ‚Äî Voice to order</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#0c0f14; --panel:#141823; --card:#111625; --btn:#1f2737;
      --accent:#ff7a18; --ok:#22c55e; --danger:#ef4444; --muted:#94a3b8;
      --ring:rgba(255,122,24,.25)
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;color:#e5e7eb;background:#0b0f14 fixed no-repeat center/cover url("./images/Background.png");
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans","Liberation Sans",Arial,"Apple Color Emoji","Segoe UI Emoji"
    }
    .scrim{backdrop-filter:saturate(110%) blur(2px)}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    .topbar{display:flex;align-items:center;gap:14px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{width:36px;height:36px;border-radius:9px;display:block}
    .brand h1{margin:0;font-weight:800}
    .brand .free{color:#ff7a18}.brand .flow{color:#fff}

    .actions{margin-left:auto;display:flex;gap:10px}
    .iconbtn{width:42px;height:42px;border-radius:12px;display:grid;place-items:center;
      background:linear-gradient(180deg,#1a2231,#131a26); border:1px solid #2a3446; color:#d1d5db; cursor:pointer}
    .badge{position:absolute translate: 10px -10px; background:#ff7a18;color:#000;font-weight:700;
      font-size:12px;border-radius:999px;padding:2px 6px;border:1px solid #0009}

    .panel{margin-top:16px;padding:18px;border-radius:16px;background:radial-gradient(200% 140% at 100% 0%, #0f1520, #0b0f14 60%);border:1px solid #1f2634}
    .section{background:#0f1420; border:1px solid #1c2332; border-radius:16px; padding:16px; margin:16px 0}
    .section h3{margin:0 0 10px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input[type=text], textarea{
      width:100%; background:#0b101a; color:#e5e7eb; border:1px solid #222a39; border-radius:12px; padding:12px 14px;
      outline:none; box-shadow:none
    }
    textarea{min-height:120px; resize:vertical}
    .btn{
      background:#1c2433; border:1px solid #2a3446; color:#e5e7eb; padding:12px 16px; border-radius:12px; cursor:pointer;
      transition:.15s; font-weight:600
    }
    .btn:hover{filter:brightness(1.08)}
    .btn.primary{background:linear-gradient(180deg,#26324a,#1c2436); border-color:#33405a}
    .btn.success{background:#12341d;border-color:#165a2f;color:#c7ffd7}
    .btn.danger{background:#3a1111;border-color:#6a1b1b;color:#ffd1d1}
    .status{font-size:14px;color:#a8b3c7;margin-top:8px}
    .ok{color:var(--ok)} .bad{color:var(--danger)}

    /* hamburger */
    .drawer-backdrop{position:fixed;inset:0;background:#0008;opacity:0;pointer-events:none;transition:.2s}
    .drawer{position:fixed;top:0;right:0;height:100%;width:92vw;max-width:420px;background:#0e1421;border-left:1px solid #252e3f;
      transform:translateX(100%);transition:.25s;display:flex;flex-direction:column}
    .drawer.open{transform:none}
    .drawer-backdrop.open{opacity:1;pointer-events:all}
    .drawer .head{display:flex;align-items:center;gap:10px;padding:16px;border-bottom:1px solid #1e2737}
    .drawer .head img{width:28px;height:28px;border-radius:8px}
    .drawer .content{padding:16px;overflow:auto}
    .group{margin:12px 0}
    .group h4{margin:0 0 8px 0;color:#cbd5e1}
    .tile{background:#0b101a;border:1px solid #1f2838;border-radius:12px;padding:12px 14px;margin:8px 0;display:flex;align-items:center;justify-content:space-between}
    .muted{color:#94a3b8}
    .pillbar{display:flex;gap:10px;position:sticky;bottom:16px;margin-top:16px}
    .pill{flex:1;text-align:center;padding:14px;border-radius:16px;background:#0b101a;border:1px solid #262f40}

    /* mic bubble row */
    .microw{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:10px 14px;border:1px solid #273247;background:#0e1624}
    .dot{width:10px;height:10px;border-radius:99px;background:#475569}
    .dot.live{background:#ef4444; box-shadow:0 0 0 6px #ef444433}
    small{color:#94a3b8}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <img src="./images/Freeflowlogo.png" alt="FreeFlow Logo" />
        <h1 class="free">Free<span class="flow">Flow</span></h1>
      </div>
      <div class="actions">
        <button id="cartBtn" class="iconbtn" title="Koszyk" aria-label="Koszyk">üõí</button>
        <button id="menuBtn" class="iconbtn" title="Menu" aria-label="Menu">‚ò∞</button>
      </div>
    </div>

    <div class="panel scrim">
      <h2 style="margin:0 0 8px 0">Voice to order ‚Äî Z≈Ç√≥≈º zam√≥wienie</h2>
      <p class="muted" style="margin:0 0 14px 0">Restauracja, taxi albo hotel?</p>

      <!-- Ustawienia backendu -->
      <div class="section">
        <h3>URL backendu (Vercel)</h3>
        <div class="row">
          <input id="backendUrl" type="text" placeholder="https://tw√≥j-backend.vercel.app" />
          <button id="saveBackend" class="btn primary">Zapisz</button>
          <button id="pingBtn" class="btn">Ping /health</button>
        </div>
        <div id="healthStatus" class="status">Stan: <span class="muted">nieznany</span></div>
      </div>

      <!-- Szukanie -->
      <div class="section">
        <h3>Wyszukiwanie po lokalizacji</h3>
        <div class="row">
          <input id="geoInput" type="text" placeholder="Wpisz miasto lub adres‚Ä¶" />
          <button class="btn">üîé</button>
        </div>
      </div>

      <!-- Asystent -->
      <div class="section">
        <div class="row" style="align-items:center;justify-content:space-between">
          <h3 style="margin:0">Asystent ‚Äî kr√≥tkie odpowiedzi PL</h3>
          <small>model: gpt-4o-mini</small>
        </div>
        <p class="muted">Przyk≈Çad: ‚ÄûZam√≥wiƒá dwie pizze na Kazimierzu ‚Äî jaka dzielnica?‚Äù</p>

        <textarea id="prompt" placeholder="Napisz wiadomo≈õƒá‚Ä¶"></textarea>

        <div class="row" style="margin-top:10px">
          <button id="sendBtn" class="btn success">Wy≈õlij do /api/gpt</button>
          <button id="clearBtn" class="btn">Wyczy≈õƒá</button>
          <button id="ttsBtn" class="btn">üîä Odtw√≥rz odpowied≈∫</button>
        </div>

        <div class="microw" style="margin-top:12px">
          <span class="chip"><span id="liveDot" class="dot"></span> <span id="recLabel">Mikrofon: gotowy</span></span>
          <button id="recBtn" class="btn">üéôÔ∏è Nagraj</button>
          <button id="stopBtn" class="btn danger" disabled>‚ñ† Stop</button>
        </div>

        <div style="margin-top:12px">
          <label class="muted">Odpowied≈∫</label>
          <textarea id="reply" readonly></textarea>
        </div>
      </div>

      <!-- Kafelki na dole -->
      <div class="row">
        <div class="pill">üçΩÔ∏è Jedzenie</div>
        <div class="pill">üöï Taxi</div>
        <div class="pill">üè® Hotele</div>
      </div>
    </div>
  </div>

  <!-- Drawer -->
  <div id="drawerBackdrop" class="drawer-backdrop"></div>
  <aside id="drawer" class="drawer">
    <div class="head">
      <img src="./images/Freeflowlogo.png" alt="Logo">
      <div>
        <div style="font-weight:700">FreeFlow</div>
        <div class="muted" style="font-size:12px">Niezalogowany</div>
      </div>
      <button id="closeDrawer" class="iconbtn" style="margin-left:auto" aria-label="Zamknij">‚úï</button>
    </div>
    <div class="content">
      <div class="group">
        <h4>Klient Prywatny</h4>
        <div class="tile">Zaloguj siƒô <span class="muted">‚Üí</span></div>
        <div class="tile">Zarejestruj konto <span class="muted">‚Üí</span></div>
        <div class="tile">Moje zam√≥wienia <span class="muted">‚Üí</span></div>
        <div class="tile">Ulubione restauracje <span class="muted">‚Üí</span></div>
      </div>
      <div class="group">
        <h4>Firma</h4>
        <div class="tile">Panel firmy <span class="muted">‚Üí</span></div>
      </div>
      <div class="group">
        <h4>Wsparcie i Ustawienia</h4>
        <div class="tile">FAQ / pomoc <span class="muted">‚Üí</span></div>
        <div class="tile">Ustawienia aplikacji <span class="muted">‚Üí</span></div>
        <div class="tile">Jƒôzyk / waluta <span class="muted">‚Üí</span></div>
      </div>
    </div>
  </aside>

  <script>
    // ---------- storage helpers ----------
    const store = {
      get(k, def=""){ try{ const v=localStorage.getItem(k); return v ?? def }catch{ return def } },
      set(k, v){ try{ localStorage.setItem(k, v) }catch{} }
    };

    // ---------- elements ----------
    const backendInput = document.getElementById('backendUrl');
    const saveBackend  = document.getElementById('saveBackend');
    const pingBtn      = document.getElementById('pingBtn');
    const healthStatus = document.getElementById('healthStatus');

    const promptEl = document.getElementById('prompt');
    const replyEl  = document.getElementById('reply');
    const sendBtn  = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const ttsBtn   = document.getElementById('ttsBtn');

    const recBtn   = document.getElementById('recBtn');
    const stopBtn  = document.getElementById('stopBtn');
    const recLabel = document.getElementById('recLabel');
    const liveDot  = document.getElementById('liveDot');

    const drawer        = document.getElementById('drawer');
    const drawerBackdrop= document.getElementById('drawerBackdrop');
    const menuBtn       = document.getElementById('menuBtn');
    const closeDrawer   = document.getElementById('closeDrawer');

    // ---------- init ----------
    const DEFAULT_BACKEND = "https://freeflow-backend-vercel.vercel.app";
    backendInput.value = store.get('backendUrl', DEFAULT_BACKEND);

    function setStatus(ok, text){
      healthStatus.innerHTML = `Stan: <span class="${ok?'ok':'bad'}">${text}</span>`;
    }

    // ---------- backend controls ----------
    saveBackend.addEventListener('click', ()=>{
      store.set('backendUrl', backendInput.value.trim());
      setStatus(true,"zapisano URL");
    });

    pingBtn.addEventListener('click', async ()=>{
      const url = backendInput.value.trim().replace(/\/$/,'') + "/api/health";
      setStatus(true, "sprawdzanie‚Ä¶");
      try{
        const res = await fetch(url, {headers:{'accept':'application/json'}});
        if(!res.ok) throw new Error(res.status);
        const j = await res.json().catch(()=> ({}));
        setStatus(true, "OK ‚úÖ");
      }catch(e){
        setStatus(false, "b≈ÇƒÖd");
      }
    });

    // ---------- /api/gpt ----------
    sendBtn.addEventListener('click', async ()=>{
      const base = backendInput.value.trim().replace(/\/$/,'');
      const url  = base + "/api/gpt";
      const prompt = promptEl.value.trim();
      if(!prompt){ promptEl.focus(); return; }

      sendBtn.disabled = true; sendBtn.textContent = "Wysy≈Çanie‚Ä¶";
      try{
        const res = await fetch(url, {
          method:"POST",
          headers:{ "content-type":"application/json", "accept":"application/json" },
          body: JSON.stringify({ prompt })
        });
        const data = await res.json().catch(()=> ({}));
        replyEl.value = data.reply ?? JSON.stringify(data,null,2);
      }catch(err){
        replyEl.value = "B≈ÇƒÖd po≈ÇƒÖczenia z backendem.";
      }finally{
        sendBtn.disabled = false; sendBtn.textContent = "Wy≈õlij do /api/gpt";
      }
    });

    clearBtn.addEventListener('click', ()=>{ promptEl.value=""; replyEl.value=""; });

    // ---------- TTS (Web Speech API) ----------
    function speak(text){
      if(!("speechSynthesis" in window)){ alert("TTS nieobs≈Çugiwany w tej przeglƒÖdarce."); return; }
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "pl-PL";
      u.rate = 1.0; u.pitch = 1.0;
      speechSynthesis.speak(u);
    }
    ttsBtn.addEventListener('click', ()=> speak(replyEl.value || "Brak odpowiedzi."));

    // ---------- Recording (MediaRecorder) ----------
    let media, rec, chunks=[];
    async function startRec(){
      try{
        media = await navigator.mediaDevices.getUserMedia({ audio:true });
        rec = new MediaRecorder(media, {mimeType: 'audio/webm'});
        chunks = [];
        rec.ondataavailable = e=> { if(e.data.size) chunks.push(e.data); };
        rec.onstop = onRecStop;
        rec.start();
        liveDot.classList.add('live');
        recLabel.textContent = "Nagrywanie‚Ä¶";
        recBtn.disabled = true; stopBtn.disabled = false;
      }catch(e){
        recLabel.textContent = "Brak dostƒôpu do mikrofonu";
      }
    }
    async function onRecStop(){
      liveDot.classList.remove('live');
      recBtn.disabled = false; stopBtn.disabled = true;
      recLabel.textContent = "Wysy≈Çanie audio‚Ä¶";
      const blob = new Blob(chunks, {type:'audio/webm'});
      chunks = [];
      try{
        const base = backendInput.value.trim().replace(/\/$/,'');
        const url  = base + "/api/gpt"; // backend mo≈ºe wykrywaƒá audio po Content-Type
        const form = new FormData();
        form.append("audio", blob, "voice.webm");
        const res = await fetch(url, { method:"POST", body: form });
        const data = await res.json().catch(()=> ({}));
        replyEl.value = data.reply ?? "[OK] Audio wys≈Çane, odpowied≈∫ brak.";
        recLabel.textContent = "Gotowy";
      }catch(e){
        recLabel.textContent = "B≈ÇƒÖd wysy≈Çki audio";
      }finally{
        media?.getTracks().forEach(t=>t.stop());
      }
    }
    recBtn.addEventListener('click', startRec);
    stopBtn.addEventListener('click', ()=> rec?.state==="recording" && rec.stop());

    // ---------- Drawer ----------
    function openDrawer(open){
      drawer.classList.toggle('open', open);
      drawerBackdrop.classList.toggle('open', open);
    }
    menuBtn.addEventListener('click', ()=> openDrawer(true));
    closeDrawer.addEventListener('click', ()=> openDrawer(false));
    drawerBackdrop.addEventListener('click', ()=> openDrawer(false));

    // Prefill demo tekst
    if(!promptEl.value){
      promptEl.value = "Zam√≥wiƒá dwie pizze na Kazimierzu ‚Äî jaka to dzielnica?";
    }
  </script>
</body>
</html>
