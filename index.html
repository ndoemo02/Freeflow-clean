<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FreeFlow ‚Äî Voice to order</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0c0f14; --panel:#141823; --card:#111625; --btn:#1f2737; --brand:#ff7a00; --ok:#1db954; --muted:#94a3b8;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 70% 15%, #0f121a 0%, #0c0f14 50%, #0b0e13 100%);
      color:#e5ecff; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }
    a{color:inherit;text-decoration:none}
    .shell{min-height:100dvh; display:flex; flex-direction:column; position:relative}
    /* Top bar */
    .top{
      position:sticky; top:0; z-index:50; backdrop-filter:saturate(120%) blur(6px);
      background:linear-gradient(to bottom, rgba(12,15,20,.9), rgba(12,15,20,.4) 60%, transparent);
      padding:14px 18px 8px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px;
      font-size:26px;
    }
    .brand .free{color:var(--brand)}
    .actions{display:flex; gap:10px}
    .iconbtn{
      display:grid; place-items:center; width:44px; height:44px; border-radius:14px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.06);
    }
    .pill{position:absolute; top:-6px; right:-6px; background:var(--brand); color:#000; width:20px;height:20px; border-radius:50%; font-size:12px; display:grid; place-items:center; font-weight:700}

    /* Hero */
    .hero{
      position:relative; margin:8px 16px 0; border-radius:24px; overflow:hidden; min-height:420px;
      background:#0b0f15 url("./images/Background.png") center/cover no-repeat;
      border:1px solid rgba(255,255,255,.06);
    }
    .hero::after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(180deg, rgba(11,14,19,.35) 0%, rgba(11,14,19,.75) 55%, rgba(11,14,19,.92) 100%);
    }
    .hero-inner{position:absolute; inset:0; display:flex; flex-direction:column; padding:22px}
    .hero h1{margin:0 0 6px; font-size:40px; letter-spacing:.3px}
    .hero p{margin:0; color:var(--muted)}
    .logo{
      margin:auto; width:min(560px, 88%); max-height:360px; object-fit:contain; filter:drop-shadow(0 12px 40px rgba(0,0,0,.6));
    }

    /* Floating mic bar */
    .micbar{
      position:absolute; left:50%; bottom:20px; transform:translateX(-50%);
      width:min(980px, 92%); background:rgba(17,22,37,.86); border:1px solid rgba(255,255,255,.06);
      border-radius:18px; padding:10px; display:flex; gap:10px; align-items:center; backdrop-filter:blur(6px);
    }
    .micdot{width:10px; height:10px; border-radius:50%; background:#3b82f6; box-shadow:0 0 0 6px rgba(59,130,246,.15)}
    .micinput{flex:1; border:none; outline:none; background:transparent; color:#e8f0ff; font-size:16px}
    .cta{display:flex; gap:12px}
    .btn{
      background:var(--btn); border:1px solid rgba(255,255,255,.08); color:#e8f0ff;
      padding:12px 16px; border-radius:14px; font-weight:600; cursor:pointer;
    }
    .btn.primary{background:#107a46; border-color:#0c5d35}
    .btn.warn{background:#7a1010; border-color:#5d0c0c}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    /* Sections */
    .section{margin:18px 16px 0; padding:18px; background:rgba(17,22,37,.7); border:1px solid rgba(255,255,255,.06); border-radius:22px}
    .sec-title{display:flex; justify-content:space-between; align-items:end; margin-bottom:10px}
    .sec-title h2{margin:0; font-size:22px}
    .muted{color:var(--muted)}
    .field{display:flex; gap:10px; align-items:center}
    .input{
      flex:1; min-height:48px; padding:0 14px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
      background:#0e1320; color:#e8f0ff; outline:none;
    }

    /* Bottom quick categories */
    .quick{display:flex; gap:16px; justify-content:center; padding:22px 16px 32px}
    .chip{
      min-width:140px; padding:14px 18px; display:flex; gap:12px; align-items:center; justify-content:center;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.06); border-radius:18px;
      font-weight:700;
    }

    /* Drawer (hamburger) */
    dialog.drawer{
      inset:auto 0 0 auto; margin:0; width:min(660px, 92%); max-height:85dvh; border:none; padding:0;
      background:rgba(17,22,37,.98); color:#eaf2ff; border-radius:20px 20px 0 0;
      border:1px solid rgba(255,255,255,.08);
    }
    .drawer::backdrop{background:rgba(0,0,0,.35) }
    .drawer .head{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.06)}
    .drawer .box{padding:14px 16px}
    .card{background:#0f1526; border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:14px}
    .row{display:flex; align-items:center; gap:10px}
    .row + .row{margin-top:10px}
    .arrow{margin-left:auto; opacity:.7}

    @media (min-width:900px){
      .hero{min-height:520px}
      .hero h1{font-size:52px}
      .micbar{bottom:26px}
    }
  </style>
</head>
<body>
<div class="shell">

  <!-- Top bar -->
  <div class="top">
    <div class="brand"><span class="free">Free</span>Flow</div>
    <div class="actions">
      <a class="iconbtn" href="#" title="Koszyk">
        <span class="pill">0</span>
        üõí
      </a>
      <button class="iconbtn" id="btnMenu" title="Menu">‚ò∞</button>
    </div>
  </div>

  <!-- Hero -->
  <section class="hero">
    <div class="hero-inner">
      <div>
        <h1>Voice to order ‚Äî Z≈Ç√≥≈º zam√≥wienie</h1>
        <p>Restauracja, taxi albo hotel?</p>
      </div>
      <img class="logo" src="./images/Freeflowlogo.png" alt="FreeFlow Logo" />
      <div class="micbar">
        <div class="micdot" id="recDot" title="status"></div>
        <input id="micText" class="micinput" placeholder="Kliknij logo aby z≈Ço≈ºyƒá zam√≥wienie" />
        <div class="cta">
          <button class="btn" id="btnRec">üéôÔ∏è Nagraj</button>
          <button class="btn warn" id="btnStop" disabled>‚ñ† Stop</button>
          <button class="btn primary" id="btnSend">Wy≈õlij</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Backend config -->
  <section class="section">
    <div class="sec-title">
      <h2>URL backendu (Vercel)</h2>
      <span id="healthStatus" class="muted">Stan: nieznany</span>
    </div>
    <div class="field" style="margin-top:8px">
      <input id="backendUrl" class="input" placeholder="https://twoj-backend.vercel.app" />
      <button class="btn" id="btnSave">Zapisz</button>
      <button class="btn" id="btnPing">Ping /health</button>
    </div>
  </section>

  <!-- GPT short answers -->
  <section class="section" id="assist">
    <div class="sec-title">
      <h2>Asystent ‚Äî kr√≥tkie odpowiedzi PL</h2>
      <span class="muted">model: gpt-4o-mini</span>
    </div>

    <div class="muted" style="margin-bottom:12px">
      Przyk≈Çad: ‚ÄûZam√≥wiƒá dwie pizze na Kazimierzu ‚Äî jaka dzielnica?‚Äù
    </div>

    <textarea id="prompt" class="input" style="min-height:120px; padding:12px"
      placeholder="Napisz wiadomo≈õƒá lub u≈ºyj Nagraj"></textarea>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
      <button class="btn primary" id="btnCall">Wy≈õlij do /api/gpt</button>
      <button class="btn" id="btnClear">Wyczy≈õƒá</button>
      <button class="btn" id="btnSpeak">üîä Odtw√≥rz odpowied≈∫</button>
    </div>

    <div style="margin-top:12px">
      <label class="muted" style="display:block; margin-bottom:6px">Odpowied≈∫</label>
      <textarea id="reply" class="input" style="min-height:90px; padding:12px" readonly></textarea>
    </div>
  </section>

  <!-- Quick categories -->
  <div class="quick">
    <div class="chip">üçΩÔ∏è Jedzenie</div>
    <div class="chip">üöï Taxi</div>
    <div class="chip">üè® Hotele</div>
  </div>

  <!-- Drawer -->
  <dialog class="drawer" id="drawer">
    <div class="head">
      <div class="row" style="gap:12px">
        <div class="iconbtn" style="width:42px;height:42px">üë§</div>
        <div>
          <div style="font-weight:700">Administrator FreeFlow</div>
          <div class="muted" style="font-size:14px">admin@freeflow.com</div>
        </div>
      </div>
      <button class="iconbtn" id="btnCloseDrawer">‚úï</button>
    </div>
    <div class="box">
      <div class="card">
        <div class="row"><span>‚öôÔ∏è Panel u≈ºytkownika</span><span class="arrow">‚Ä∫</span></div>
        <div class="row"><span>üó£Ô∏è G≈Çosowe zamawianie</span><span class="arrow">‚Ä∫</span></div>
        <div class="row"><span>üßæ Twoje zam√≥wienia</span><span class="arrow">‚Ä∫</span></div>
        <div class="row"><span>‚ùì FAQ</span><span class="arrow">‚Ä∫</span></div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn warn">Wyloguj siƒô</button>
      </div>
    </div>
  </dialog>

</div>

<script>
(() => {
  const $ = (s) => document.querySelector(s);
  const backendInput = $('#backendUrl');
  const healthStatus = $('#healthStatus');
  const promptEl = $('#prompt');
  const replyEl = $('#reply');
  const micText = $('#micText');
  const recDot = $('#recDot');
  const btnRec = $('#btnRec');
  const btnStop = $('#btnStop');
  const btnSendTop = $('#btnSend');
  const drawer = $('#drawer');

  /* -------- Storage for backend -------- */
  const LS_KEY = 'freeflow.backend';
  function getBase(){
    return (localStorage.getItem(LS_KEY) || '').trim();
  }
  function setBase(u){
    localStorage.setItem(LS_KEY, u.trim());
  }
  backendInput.value = getBase();

  $('#btnSave').onclick = () => {
    setBase(backendInput.value || '');
    healthStatus.textContent = 'Stan: zapisano';
    setTimeout(()=>healthStatus.textContent='Stan: nieznany', 1200);
  };

  $('#btnPing').onclick = async () => {
    const base = getBase();
    if(!base){ healthStatus.textContent='Stan: brak URL'; return; }
    healthStatus.textContent = 'Sprawdzam‚Ä¶';
    try{
      const r = await fetch(base.replace(/\/$/,'') + '/api/health', {mode:'cors'});
      if(r.ok){ healthStatus.textContent='Stan: OK ‚úÖ'; }
      else { healthStatus.textContent='Stan: b≈ÇƒÖd ('+r.status+')'; }
    }catch(e){
      healthStatus.textContent='Stan: b≈ÇƒÖd';
    }
  };

  /* -------- Drawer -------- */
  $('#btnMenu').onclick = () => drawer.showModal();
  $('#btnCloseDrawer').onclick = () => drawer.close();

  /* -------- GPT call -------- */
  async function callGPT(text){
    const base = getBase();
    if(!base){ replyEl.value='[B≈ÅƒÑD] Ustaw URL backendu.'; return; }
    replyEl.value='Wysy≈Çam‚Ä¶';
    try{
      const r = await fetch(base.replace(/\/$/,'') + '/api/gpt', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body:JSON.stringify({ prompt: text })
      });
      const data = await r.json().catch(()=> ({}));
      replyEl.value = data.reply || '[OK] Brak tre≈õci odpowiedzi.';
    }catch(e){
      replyEl.value = '[B≈ÅƒÑD] ' + (e?.message || 'Nieznany b≈ÇƒÖd');
    }
  }
  $('#btnCall').onclick = () => callGPT(promptEl.value.trim() || micText.value.trim());
  $('#btnClear').onclick = () => { promptEl.value=''; replyEl.value=''; };

  /* -------- TTS (odtw√≥rz odpowied≈∫) -------- */
  async function speak(text){
    const base = getBase();
    if(!text){ return; }
    if(base){
      try{
        const r = await fetch(base.replace(/\/$/,'') + '/api/tts', {
          method:'POST',
          headers:{},
          body: (() => {
            const fd = new FormData();
            fd.append('text', text);
            return fd;
          })()
        });
        if(!r.ok){ throw new Error('HTTP '+r.status); }
        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        const audio = new Audio(url);
        audio.play().then(()=> URL.revokeObjectURL(url));
        return;
      }catch(e){
        // fallback
      }
    }
    // Fallback na SpeechSynthesis (bez sieci)
    if('speechSynthesis' in window){
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'pl-PL';
      speechSynthesis.speak(u);
    }
  }
  $('#btnSpeak').onclick = () => speak(replyEl.value.trim());

  /* -------- Recording (MediaRecorder) -------- */
  let media, recorder, chunks = [];
  function setRecUI(active){
    recDot.style.background = active ? '#ef4444' : '#3b82f6';
    btnRec.disabled = active;
    btnStop.disabled = !active;
  }

  btnRec.onclick = async () => {
    try{
      media = await navigator.mediaDevices.getUserMedia({audio:true});
      recorder = new MediaRecorder(media, {mimeType:'audio/webm'});
      chunks = [];
      recorder.ondataavailable = (e)=> { if(e.data?.size) chunks.push(e.data); };
      recorder.onstop = async () => {
        setRecUI(false);
        try{
          const blob = new Blob(chunks, {type:'audio/webm'});
          chunks = [];
          // wy≈õlij do backendu jako /api/gpt (audio)
          const base = getBase();
          if(!base){ replyEl.value='[B≈ÅƒÑD] Ustaw URL backendu.'; return; }
          const fd = new FormData();
          fd.append('audio', blob, 'recording.webm');
          const r = await fetch(base.replace(/\/$/,'') + '/api/gpt', { method:'POST', body:fd });
          const data = await r.json().catch(()=> ({}));
          replyEl.value = data.reply || '[OK] Audio wys≈Çane, odpowied≈∫ brak.';
        }catch(err){
          replyEl.value = '[B≈ÅƒÑD audio] ' + (err?.message||'');
        }finally{
          media.getTracks().forEach(t=>t.stop());
        }
      };
      recorder.start();
      setRecUI(true);
    }catch(e){
      replyEl.value = '[B≈ÅƒÑD mikrofonu] ' + (e?.message||'Odmowa dostƒôpu');
    }
  };

  btnStop.onclick = () => {
    if(recorder && recorder.state!=='inactive'){ recorder.stop(); }
  };

  /* G√≥rny ‚ÄúWy≈õlij‚Äù nad miksem */
  btnSendTop.onclick = () => callGPT(micText.value.trim() || promptEl.value.trim());

  /* Prefill backend from LS once */
  if(!backendInput.value){
    // opcjonalnie: wpisz sw√≥j domy≈õlny
    // backendInput.value = 'https://freeflow-backend-vercel.vercel.app';
  }
})();
</script>
</body>
</html>
