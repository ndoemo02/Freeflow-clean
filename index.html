<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FreeFlow ‚Äî Voice to order</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121a22; --card:#0f1620; --txt:#e6eef7; --muted:#9fb0c3;
      --brand:#ff812b; --ok:#26d07c; --danger:#ff4d4d; --btn:#1f6c3f; --btn2:#223344; --accent:#1f8fff;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 800px at 80% -10%,#101826 0%,#0b0f14 60%),
                linear-gradient(180deg,#0b0f14 0%,#0b0f14 100%);
      color:var(--txt); font:400 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    }
    .wrap{max-width:980px; margin:0 auto; padding:20px 16px 64px}
    header{display:flex; align-items:center; gap:16px; margin:8px 0 18px}
    .brand{font-weight:800; font-size:30px; letter-spacing:.2px}
    .brand .a{color:var(--brand)}
    .panel{background:linear-gradient(180deg,#111925 0%,#0f1721 100%); border:1px solid #1c2a3a;
      border-radius:var(--radius); padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.25); margin:0 0 18px}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    label{display:block; color:var(--muted); font-size:14px; margin:0 0 10px}
    input, textarea{
      width:100%; color:var(--txt); background:#0c141e; border:1px solid #243447; border-radius:12px;
      padding:14px 14px; outline:none; transition:.15s border-color,.15s box-shadow;
    }
    input:focus, textarea:focus{border-color:#2b71ff; box-shadow:0 0 0 3px rgba(43,113,255,.15)}
    textarea{min-height:130px; resize:vertical}
    .btn{
      appearance:none; border:0; border-radius:12px; padding:12px 16px; color:#fff; cursor:pointer;
      background:var(--btn); font-weight:600; letter-spacing:.2px; transition:filter .12s, transform .02s;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:var(--btn2)}
    .btn.accent{background:var(--accent)}
    .btn.warn{background:var(--danger)}
    .status{font-weight:600; color:var(--muted)}
    .ok{color:var(--ok)} .bad{color:var(--danger)}
    .chips{display:flex; gap:10px; flex-wrap:wrap}
    .chip{background:#0c141e; border:1px solid #243447; padding:8px 12px; border-radius:999px; color:var(--muted)}
    .muted{color:var(--muted)}
    .out{white-space:pre-wrap; background:#0c141e; border:1px solid #243447; border-radius:12px; padding:14px}
    .section-title{display:flex; justify-content:space-between; align-items:center; gap:12px}
    .mini{font-size:13px; color:var(--muted)}
    /* chowamy watermarky */
    .minimax-badge, [class*="Created by MiniMax"], [data-minimax-badge] { display:none !important; visibility:hidden !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><span class="a">Free</span>Flow</div>
      <div class="chip">Voice to order ‚Äî Z≈Ç√≥≈º zam√≥wienie</div>
    </header>

    <!-- Backend URL + Ping -->
    <section class="panel">
      <div class="section-title">
        <h3 style="margin:0">URL backendu (Vercel)</h3>
        <div id="healthStatus" class="status">Stan: <span class="muted">nieznany</span></div>
      </div>
      <label for="backendUrl">Adres (np. https://twoj-backend.vercel.app)</label>
      <div class="row">
        <input id="backendUrl" placeholder="https://..." inputmode="url" />
        <button id="saveUrl" class="btn">Zapisz</button>
        <button id="pingBtn" class="btn secondary">Ping /health</button>
      </div>
    </section>

    <!-- Location search (placeholder pod przysz≈Çe feature‚Äôy) -->
    <section class="panel">
      <h3 style="margin:0 0 10px">Wyszukiwanie po lokalizacji</h3>
      <div class="row">
        <input id="geo" placeholder="Wpisz miasto lub adres‚Ä¶" />
        <button class="btn secondary" id="geoBtn">üîé</button>
      </div>
    </section>

    <!-- Assistant -->
    <section class="panel">
      <div class="section-title">
        <h3 style="margin:0">Asystent ‚Äî kr√≥tkie odpowiedzi PL</h3>
        <div class="mini">model: gpt-4o-mini</div>
      </div>
      <p class="muted" style="margin-top:6px">
        Przyk≈Çad: ‚ÄûZam√≥wiƒá dwie pizze na Kazimierzu ‚Äî jaka dzielnica?‚Äù
      </p>

      <label for="prompt">Wiadomo≈õƒá</label>
      <textarea id="prompt" placeholder="Napisz lub u≈ºyj mikrofonu‚Ä¶"></textarea>

      <div class="row" style="margin-top:10px">
        <button id="sendBtn" class="btn accent">Wy≈õlij do /api/gpt</button>
        <button id="clearBtn" class="btn secondary">Wyczy≈õƒá</button>
        <button id="micBtn" class="btn">üéôÔ∏è M√≥w</button>
        <button id="stopTtsBtn" class="btn secondary">‚èπÔ∏è TTS</button>
      </div>

      <h4 style="margin:18px 0 8px">Odpowied≈∫</h4>
      <div id="reply" class="out">‚Äì</div>
    </section>

    <div class="chips" style="margin-top:10px">
      <div class="chip">üçΩÔ∏è Jedzenie</div>
      <div class="chip">üöñ Taxi</div>
      <div class="chip">üè® Hotele</div>
    </div>
  </div>

  <script>
    // ===== Helpers: storage + UI =====
    const $ = s => document.querySelector(s);
    const backendInput = $('#backendUrl');
    const healthStatus = $('#healthStatus');
    const replyEl = $('#reply');
    const promptEl = $('#prompt');

    const STORAGE_KEY = 'ff_backend_url';

    const getBase = () => (backendInput.value || '').trim().replace(/\/+$/,'');
    const setStatus = (ok, text) => {
      healthStatus.innerHTML = 'Stan: ' + (ok ? `<span class="ok">OK</span>` : `<span class="bad">${text||'B≈ÅƒÑD'}</span>`);
    };

    // init
    (function init() {
      const saved = localStorage.getItem(STORAGE_KEY) || '';
      if (saved) backendInput.value = saved;
      // automatyczny ping przy starcie (je≈õli mamy URL)
      if (saved) ping();
    })();

    // ===== Ping /health =====
    async function ping() {
      const base = getBase();
      if (!base) { setStatus(false, 'brak URL'); return; }
      setStatus(false, 'sprawdzam‚Ä¶');
      try {
        const r = await fetch(`${base}/api/health`, { method:'GET' });
        const ok = r.ok;
        let txt = '';
        try { txt = await r.text(); } catch(_){}
        setStatus(ok, ok ? 'OK' : (txt || `HTTP ${r.status}`));
      } catch (e) {
        setStatus(false, e.message || 'b≈ÇƒÖd sieci');
      }
    }

    // ===== Save URL =====
    $('#saveUrl').onclick = () => {
      const val = getBase();
      if (!val) {
        alert('Podaj poprawny URL backendu (https://‚Ä¶ ).');
        return;
      }
      localStorage.setItem(STORAGE_KEY, val);
      ping();
    };
    $('#pingBtn').onclick = ping;

    // ===== Send prompt -> /api/gpt =====
    let ttsEnabled = true;
    $('#sendBtn').onclick = async () => {
      const base = getBase();
      if (!base) return alert('Najpierw zapisz URL backendu.');
      const prompt = promptEl.value.trim();
      if (!prompt) return alert('Wpisz wiadomo≈õƒá.');

      replyEl.textContent = '‚Ä¶';
      try {
        const r = await fetch(`${base}/api/gpt`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ prompt })
        });
        let out = '';
        if (r.ok) {
          const data = await r.json().catch(()=>null);
          out = data?.reply || JSON.stringify(data);
        } else {
          out = `B≈ÇƒÖd API (${r.status})`;
          const t = await r.text().catch(()=> '');
          if (t) out += `\n${t}`;
        }
        replyEl.textContent = out || '‚Äî';
        if (out && ttsEnabled) speak(out);
      } catch (e) {
        replyEl.textContent = `B≈ÇƒÖd: ${e.message || e}`;
      }
    };
    $('#clearBtn').onclick = () => { promptEl.value=''; replyEl.textContent='‚Äì'; };

    // ===== Simple Search placeholder =====
    $('#geoBtn').onclick = () => {
      const q = ($('#geo').value || '').trim();
      if (!q) return;
      alert('Wyszukiwanie (placeholder): ' + q);
    };

    // ===== ASR (webkitSpeechRecognition) =====
    const micBtn = $('#micBtn');
    let recognition = null;
    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.lang = 'pl-PL';
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onstart = () => { micBtn.textContent = 'üéôÔ∏è M√≥wiƒô‚Ä¶'; };
      recognition.onend   = () => { micBtn.textContent = 'üéôÔ∏è M√≥w'; };
      recognition.onerror = () => { micBtn.textContent = 'üéôÔ∏è M√≥w'; };

      recognition.onresult = (ev) => {
        const text = ev.results[0][0].transcript;
        promptEl.value = text;
      };

      micBtn.onclick = () => recognition.start();
    } else {
      micBtn.disabled = true;
      micBtn.title = 'ASR niedostƒôpny w tej przeglƒÖdarce';
    }

    // ===== TTS =====
    function speak(text) {
      try {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'pl-PL';
        window.speechSynthesis.cancel(); // odetnij poprzednie
        window.speechSynthesis.speak(u);
      } catch(_){}
    }
    $('#stopTtsBtn').onclick = () => {
      ttsEnabled = false;
      window.speechSynthesis.cancel();
      setTimeout(()=>ttsEnabled=true, 300); // chwilowe wyciszenie
    };
  </script>
</body>
</html>
